<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bus Product</title>
    <link rel="icon" href="/public/favicon.png" />
    <link rel="stylesheet" href="/public/styles.css" />
  </head>
  <body class="dashboard layout">
    <%- include("partials/sidebar", { active }) %>

    <section class="content">
      <header class="page-header">
        <div class="page-title">
          <h1>
            <span class="page-title-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                <path d="M8 9h8"></path>
                <path d="M8 13h5"></path>
              </svg>
            </span>
            <span>Slack Analiz</span>
          </h1>
          <p>Seçili kullanıcıların tarih aralığına göre yanıt sayıları.</p>
        </div>
        <div class="page-actions">
          <div class="user-pill"><%= user.displayName %></div>
        </div>
      </header>

      <section class="table-card panel-card slack-filter-section">
        <form class="slack-filter-form" method="get" action="/reports/slack-analysis">
          <input type="hidden" name="run" value="1" />
          <div class="slack-filter-grid">
            <label class="slack-filter-field">
              <span>Başlangıç Tarihi</span>
              <input type="date" name="startDate" value="<%= filters.startDate %>" required />
            </label>
            <label class="slack-filter-field">
              <span>Bitiş Tarihi</span>
              <input type="date" name="endDate" value="<%= filters.endDate %>" required />
            </label>
          </div>
          <div class="slack-filter-actions">
            <button type="submit">Filtrele</button>
          </div>
          <div class="slack-loading-message" hidden>Rapor hazırlanıyor, lütfen bekleyin...</div>
        </form>
      </section>

      <% if (report.notice) { %>
        <div class="inline-success"><%= report.notice %></div>
      <% } %>

      <% if (report.error) { %>
        <div class="alert inline-alert"><%= report.error %></div>
      <% } %>

      <section class="table-card panel-card">
        <div class="table-head">
          <h2>Yanıt Sonuçları</h2>
          <div class="table-actions">
            <span class="pill"><%= report.rows.length %> Kullanıcı</span>
            <span class="pill"><%= report.totalRequests %> Talep</span>
            <span class="pill"><%= report.totalReplies %> Yanıt</span>
            <span class="pill muted"><%= report.meta.channelsScanned %>/<%= report.meta.channelsTotal %> Kanal</span>
            <span class="pill muted"><%= report.meta.threadsScanned %> Thread</span>
            <% if (report.source) { %>
              <span class="pill muted">Kaynak: <%= report.source %></span>
            <% } %>
            <% if (report.requested && !report.error && report.rows.length > 0) { %>
              <form class="slack-save-form" method="post" action="/reports/slack-analysis/save">
                <input type="hidden" name="startDate" value="<%= filters.startDate %>" />
                <input type="hidden" name="endDate" value="<%= filters.endDate %>" />
                <input type="hidden" name="source" value="<%= report.source %>" />
                <input type="hidden" name="totalRequests" value="<%= report.totalRequests %>" />
                <input type="hidden" name="dbStartDate" value="<%= sqlQuery?.filters?.startDate || filters.startDate %>" />
                <input type="hidden" name="dbEndDate" value="<%= sqlQuery?.filters?.endDate || filters.endDate %>" />
                <input type="hidden" name="rowsJson" value="<%= report.rowsJson %>" />
                <button type="submit" class="button-link">SQL'e Kaydet</button>
              </form>
            <% } %>
          </div>
        </div>

        <% if (!report.requested) { %>
          <p class="muted">Filtre alanından tarih aralığı seçip `Filtrele` butonuna basın.</p>
        <% } %>

        <% if (report.requested && report.rows.length === 0 && !report.error) { %>
          <p class="muted">Seçilen tarih aralığında gösterilecek sonuç bulunamadı.</p>
        <% } %>

        <% if (report.requested && report.rows.length > 0) { %>
          <% const formatter = new Intl.NumberFormat("tr-TR"); %>
          <div class="table-scroll">
            <table class="slack-analysis-summary-table">
              <thead>
                <tr>
                  <th>Kullanıcı</th>
                  <th>Talep Sayısı</th>
                  <th>Yanıt Sayısı</th>
                </tr>
              </thead>
              <tbody>
                <% report.rows.forEach((row) => { %>
                  <tr>
                    <td title="<%= row.userId %>"><%= row.name %></td>
                    <td><%= formatter.format(row.requestCount) %></td>
                    <td><%= formatter.format(row.replyCount) %></td>
                  </tr>
                <% }) %>
              </tbody>
              <tfoot>
                <tr>
                  <td>Dip Toplam</td>
                  <td><%= formatter.format(report.totalRequests) %></td>
                  <td><%= formatter.format(report.totalReplies) %></td>
                </tr>
              </tfoot>
            </table>
          </div>
        <% } %>
      </section>

      <section class="table-card panel-card slack-sql-section">
        <div class="table-head">
          <h2>SQL Kayıt Sorgu</h2>
          <div class="table-actions">
            <% if (sqlQuery?.requested) { %>
              <span class="pill"><%= (sqlQuery.rows || []).length %> Kayıt</span>
            <% } %>
          </div>
        </div>

        <form class="slack-sql-filter-form" method="get" action="/reports/slack-analysis">
          <input type="hidden" name="dbRun" value="1" />
          <input type="hidden" name="startDate" value="<%= filters.startDate %>" />
          <input type="hidden" name="endDate" value="<%= filters.endDate %>" />
          <label class="slack-filter-field">
            <span>Başlangıç Tarihi</span>
            <input
              type="date"
              name="dbStartDate"
              value="<%= sqlQuery?.filters?.startDate || filters.startDate %>"
              required
            />
          </label>
          <label class="slack-filter-field">
            <span>Bitiş Tarihi</span>
            <input
              type="date"
              name="dbEndDate"
              value="<%= sqlQuery?.filters?.endDate || filters.endDate %>"
              required
            />
          </label>
          <button type="submit" class="button-link ghost">SQL Kayıtlarını Sorgula</button>
        </form>

        <% if (sqlQuery?.error) { %>
          <div class="alert inline-alert"><%= sqlQuery.error %></div>
        <% } %>

        <% if (sqlQuery?.requested && (sqlQuery.rows || []).length === 0 && !sqlQuery.error) { %>
          <p class="muted">Seçilen tarih aralığında SQL kaydı bulunamadı.</p>
        <% } %>

        <% if ((sqlQuery.rows || []).length > 0) { %>
          <% const formatter = new Intl.NumberFormat("tr-TR"); %>
          <div class="table-scroll">
            <table class="slack-sql-table">
              <thead>
                <tr>
                  <th>Kayıt No</th>
                  <th>Tarih Aralığı</th>
                  <th>Talep</th>
                  <th>Yanıt</th>
                  <th>Kaydetme</th>
                  <th>Güncelleme</th>
                  <th>Kullanıcı</th>
                  <th>Detay</th>
                </tr>
              </thead>
              <tbody>
                <% sqlQuery.rows.forEach((run) => { %>
                  <tr>
                    <td><%= run.runId %></td>
                    <td><%= run.startDate %> - <%= run.endDate %></td>
                    <td><%= formatter.format(run.totalRequests) %></td>
                    <td><%= formatter.format(run.totalReplies) %></td>
                    <td><%= run.saveCount %>. kez</td>
                    <td>
                      <% const updated = new Date(run.updatedAt); %>
                      <%= Number.isNaN(updated.getTime()) ? (run.updatedAt || "-") : updated.toLocaleString("tr-TR") %>
                    </td>
                    <td><%= run.createdByName || "-" %></td>
                    <td>
                      <details class="slack-sql-detail">
                        <summary>Göster</summary>
                        <% if (!run.items || run.items.length === 0) { %>
                          <p class="muted">Kullanıcı detayı yok.</p>
                        <% } %>
                        <% if (run.items && run.items.length > 0) { %>
                          <table class="slack-sql-items-table">
                            <thead>
                              <tr>
                                <th>Kullanıcı</th>
                                <th>Talep</th>
                                <th>Yanıt</th>
                              </tr>
                            </thead>
                            <tbody>
                              <% run.items.forEach((item) => { %>
                                <tr>
                                  <td title="<%= item.userId %>"><%= item.userName %></td>
                                  <td><%= formatter.format(item.requestCount) %></td>
                                  <td><%= formatter.format(item.replyCount) %></td>
                                </tr>
                              <% }) %>
                            </tbody>
                          </table>
                        <% } %>
                      </details>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        <% } %>
      </section>
    </section>
    <script src="/public/app.js" defer></script>
  </body>
</html>
